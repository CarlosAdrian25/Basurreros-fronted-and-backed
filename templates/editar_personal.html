<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editar_personal.css') }}">
    <title>Editar Personal</title>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h3>Editar Personal</h3>
            </div>
            <div class="card-body">
                <form id="editarPersonalForm">
                    <div class="mb-3">
                        <label for="nombre_completo" class="form-label">Nombre Completo:</label>
                        <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" required value="{{ user['nombre_completo'] }}">
                    </div>
                    <div class="mb-3">
                        <label for="carnet" class="form-label">Carnet:</label>
                        <input type="number" class="form-control" id="carnet" name="carnet" disabled value="{{ user['carnet_identidad'] }}">
                    </div>
                    <div class="mb-3">
                        <label for="edad" class="form-label">Edad:</label>
                        <input type="number" class="form-control" id="edad" name="edad" required value="{{ user['edad'] }}">
                    </div>
                    <div class="mb-3">
                        <label for="telefono" class="form-label">Teléfono:</label>
                        <input type="number" class="form-control" id="telefono" name="telefono" required value="{{ user['telefono'] }}">
                    </div>
                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo:</label>
                        <select class="form-select" id="tipo" name="tipo" required>
                            <option value="" disabled>Seleccione...</option>
                            <option value="conductor" {% if user['cargo'] == 'conductor' %}selected{% endif %}>Conductor</option>
                            <option value="operario" {% if user['cargo'] == 'operario' %}selected{% endif %}>Operario</option>
                            {% if user_role == "superadmin" %}
                                <option value="admin" {% if user['cargo'] == 'admin' %}selected{% endif %}>Administrador</option>
                                <option value="superadmin" {% if user['cargo'] == 'superadmin' %}selected{% endif %}>Superadministrador</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3" id="carro_asignado" {% if user['cargo'] != 'conductor' %}style="display: none;"{% endif %}>
                        <label for="carro" class="form-label">Carro Asignado:</label>
                        <select class="form-select" id="carro" name="carro">
                            {% for carro in carros_disponibles %}
                            <option value="{{ carro._id }}" {% if user['carro_asignado'] == carro._id %}selected{% endif %}>
                                {{ carro.codigo_interno }} - {{ carro.placa }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3" id="passwordField" {% if user['cargo'] != 'operario' %}style="display: block;"{% endif %}>
                        <label for="password" class="form-label">Actualizar Contraseña:</label>
                        <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <div class="text-center">
                        <button type="submit" class="gua btn w-50">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        const tipoSelect = document.getElementById('tipo');
        const passwordField = document.getElementById('passwordField');
        const carroField = document.getElementById('carro_asignado');

        // Función para manejar la visibilidad de campos según el tipo de usuario
        function handleFieldVisibility() {
            const selectedValue = tipoSelect.value;

            // Mostrar/ocultar carro asignado
            carroField.style.display = selectedValue === "conductor" ? "block" : "none";

            // Mostrar/ocultar contraseña
            passwordField.style.display = selectedValue === "operario" ? "none" : "block";
        }

        // Ejecutar al cargar la página
        window.onload = () => {
            handleFieldVisibility(); // Ajustar visibilidad inicial según el cargo actual
        };

        // Recalcular visibilidad al cambiar el tipo
        tipoSelect.addEventListener('change', handleFieldVisibility);

        // Manejar el envío del formulario
        document.getElementById('editarPersonalForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const userId = "{{ user['_id'] }}"; // Se pasa el ID desde Flask
            const data = {
                nombre_completo: document.getElementById('nombre_completo').value,
                edad: document.getElementById('edad').value,
                telefono: document.getElementById('telefono').value,
                cargo: document.getElementById('tipo').value,
                carro_asignado: document.getElementById('tipo').value === 'conductor' ? document.getElementById('carro').value : null
            };

            // Solo añadir contraseña si no es operario
            if (document.getElementById('tipo').value !== "operario") {
                data.password = document.getElementById('password').value || null;
            }

            try {
                const response = await fetch(`/web/editar_personal/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Personal actualizado correctamente.');
                    window.opener.location.reload();
                    window.close();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al actualizar el personal.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error en el servidor.');
            }
        });
    </script>
</body>
</html>
